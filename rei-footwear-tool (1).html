<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="REI Footwear">
<meta name="theme-color" content="#00843D">
<title>REI Footwear Assistant</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;900&family=Barlow:wght@400;500;600&display=swap');

  :root {
    --rei-green: #00843D;
    --rei-dark: #1a1a1a;
    --rei-light: #f0ede8;
    --rei-accent: #FF6B35;
    --rei-muted: #6b7280;
    --rei-card: #242424;
    --rei-border: #3a3a3a;
    --safe-top: env(safe-area-inset-top);
    --safe-bottom: env(safe-area-inset-bottom);
    --safe-left: env(safe-area-inset-left);
    --safe-right: env(safe-area-inset-right);
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
  }

  html {
    /* Prevent bounce scroll on iOS */
    height: 100%;
    overflow: hidden;
  }

  body {
    background: var(--rei-dark);
    color: var(--rei-light);
    font-family: 'Barlow', sans-serif;
    height: 100%;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: none;
    padding-bottom: var(--safe-bottom);
  }

  header {
    background: var(--rei-green);
    padding: 12px 20px;
    padding-top: calc(12px + var(--safe-top));
    padding-left: calc(20px + var(--safe-left));
    padding-right: calc(20px + var(--safe-right));
    display: flex;
    align-items: center;
    gap: 12px;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 12px rgba(0,0,0,0.4);
  }

  .rei-logo {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 900;
    font-size: 26px;
    letter-spacing: -1px;
    color: white;
    background: rgba(255,255,255,0.2);
    padding: 2px 10px;
    border-radius: 4px;
  }

  header h1 {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700;
    font-size: 18px;
    color: white;
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }

  main {
    max-width: 900px;
    margin: 0 auto;
    padding: 16px 16px calc(40px + var(--safe-bottom));
    padding-left: calc(16px + var(--safe-left));
    padding-right: calc(16px + var(--safe-right));
  }

  /* SCAN SECTION ‚Äî single column on mobile */
  .scan-section {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 16px;
  }

  @media (min-width: 700px) {
    .scan-section { flex-direction: row; }
    .scan-section .scan-card { flex: 1; }
  }

  .scan-card {
    background: var(--rei-card);
    border: 1px solid var(--rei-border);
    border-radius: 14px;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .card-label {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--rei-green);
  }

  /* CAMERA */
  #quagga-container {
    position: relative;
    width: 100%;
    aspect-ratio: 4/3;
    background: #111;
    border-radius: 10px;
    overflow: hidden;
  }
  #quagga-container video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    /* iOS Safari sometimes needs this */
    transform: translateZ(0);
  }

  .scan-corner {
    position: absolute;
    width: 22px; height: 22px;
    border-color: var(--rei-green);
    border-style: solid;
    border-width: 0;
    pointer-events: none;
    z-index: 2;
  }
  .scan-corner.tl { top: 18%; left: 12%; border-top-width: 3px; border-left-width: 3px; }
  .scan-corner.tr { top: 18%; right: 12%; border-top-width: 3px; border-right-width: 3px; }
  .scan-corner.bl { bottom: 18%; left: 12%; border-bottom-width: 3px; border-left-width: 3px; }
  .scan-corner.br { bottom: 18%; right: 12%; border-bottom-width: 3px; border-right-width: 3px; }

  .scan-anim-line {
    position: absolute;
    left: 12%; right: 12%;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--rei-green), transparent);
    animation: scanline 1.5s ease-in-out infinite;
    display: none;
    z-index: 2;
  }
  @keyframes scanline { 0%,100%{top:18%;opacity:0} 10%{opacity:1} 90%{opacity:1} 50%{top:80%;} }

  #scan-status {
    font-size: 13px;
    color: var(--rei-muted);
    text-align: center;
    min-height: 18px;
  }

  /* iOS-specific: hidden file input for native camera barcode scan */
  #ios-camera-input {
    display: none;
  }

  /* BUTTONS ‚Äî minimum 44px touch targets for iOS HIG */
  .btn {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700;
    font-size: 16px;
    letter-spacing: 1px;
    text-transform: uppercase;
    border: none;
    border-radius: 10px;
    padding: 12px 20px;
    min-height: 44px;
    cursor: pointer;
    transition: opacity 0.15s;
    -webkit-appearance: none;
    appearance: none;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .btn:active { opacity: 0.75; }
  .btn-primary { background: var(--rei-green); color: white; }
  .btn-secondary { background: var(--rei-border); color: var(--rei-light); }
  .btn-accent { background: var(--rei-accent); color: white; }
  .btn-sm { padding: 10px 14px; font-size: 13px; min-height: 38px; }
  .btn-row { display: flex; gap: 8px; }
  .btn-row .btn { flex: 1; }

  /* INPUTS ‚Äî font-size 16px prevents iOS zoom on focus */
  input[type="text"] {
    background: #111;
    border: 1px solid var(--rei-border);
    border-radius: 10px;
    color: var(--rei-light);
    font-family: 'Barlow', sans-serif;
    font-size: 16px; /* critical: prevents Safari auto-zoom */
    padding: 12px 14px;
    min-height: 44px;
    width: 100%;
    outline: none;
    -webkit-appearance: none;
    appearance: none;
    transition: border-color 0.2s;
  }
  input:focus { border-color: var(--rei-green); }
  input::placeholder { color: var(--rei-muted); }

  /* RESULT SECTION */
  #result-section {
    display: none;
    flex-direction: column;
    gap: 14px;
    animation: slideUp 0.25s ease;
  }
  #result-section.visible { display: flex; }
  @keyframes slideUp { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }

  .product-header {
    background: var(--rei-card);
    border: 1px solid var(--rei-border);
    border-radius: 14px;
    padding: 18px;
  }

  .badge-row {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    margin-bottom: 8px;
  }

  .product-badge {
    background: var(--rei-green);
    color: white;
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700;
    font-size: 11px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    padding: 4px 10px;
    border-radius: 5px;
  }

  .product-name {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 900;
    font-size: 26px;
    line-height: 1.1;
    color: white;
    margin-bottom: 6px;
  }

  .product-meta {
    font-size: 13px;
    color: var(--rei-muted);
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  /* CARDS ‚Äî single column on phone, 2-col on tablet */
  .cards-grid {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  @media (min-width: 600px) {
    .cards-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
    }
  }

  .info-card {
    background: var(--rei-card);
    border: 1px solid var(--rei-border);
    border-radius: 14px;
    padding: 16px;
  }

  .info-card h3 {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--rei-green);
    margin-bottom: 12px;
  }

  .pros-list, .cons-list {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 9px;
  }

  .pros-list li {
    font-size: 15px;
    padding-left: 22px;
    position: relative;
    line-height: 1.4;
  }
  .pros-list li::before { content: '‚úì'; position: absolute; left: 0; color: var(--rei-green); font-weight: 700; }

  .cons-list li {
    font-size: 15px;
    padding-left: 22px;
    position: relative;
    line-height: 1.4;
    color: #d1c9c0;
  }
  .cons-list li::before { content: '‚Äî'; position: absolute; left: 0; color: var(--rei-accent); font-weight: 700; }

  .target-text { font-size: 15px; line-height: 1.6; color: #d1c9c0; }

  .specs-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .spec-item { display: flex; flex-direction: column; gap: 2px; }
  .spec-label { font-size: 10px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; color: var(--rei-muted); }
  .spec-value { font-size: 14px; font-weight: 600; color: white; line-height: 1.3; }

  /* BAY CARD */
  .bay-card {
    background: var(--rei-card);
    border: 1px solid var(--rei-border);
    border-radius: 14px;
    padding: 16px;
  }

  .bay-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 14px;
    gap: 8px;
  }

  .bay-header h3 {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--rei-green);
  }

  .bay-btn-row { display: flex; gap: 6px; }

  .bay-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 14px; }

  .bay-item {
    display: flex;
    align-items: center;
    gap: 10px;
    background: #111;
    border-radius: 10px;
    padding: 12px;
    border: 1px solid var(--rei-border);
    min-height: 60px;
  }
  .bay-item.retrieved { opacity: 0.4; }

  .bay-number {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 900;
    font-size: 20px;
    color: var(--rei-accent);
    min-width: 58px;
  }

  /* Bay number inline input */
  .bay-number input {
    background: transparent;
    border: none;
    color: var(--rei-accent);
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 900;
    font-size: 20px;
    width: 58px;
    padding: 0;
    outline: none;
    -webkit-appearance: none;
    min-height: unset;
    border-radius: 0;
  }

  .bay-details { flex: 1; min-width: 0; }
  .bay-size { font-size: 15px; font-weight: 600; color: white; }
  .bay-sub { font-size: 12px; color: var(--rei-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  /* Large tap targets for check/remove */
  .bay-check {
    background: transparent;
    border: 2px solid var(--rei-border);
    width: 36px; height: 36px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 15px;
    transition: all 0.15s;
    flex-shrink: 0;
    color: white;
    -webkit-appearance: none;
  }
  .bay-item.retrieved .bay-check { background: var(--rei-green); border-color: var(--rei-green); }

  .btn-remove {
    background: transparent;
    border: none;
    color: var(--rei-muted);
    cursor: pointer;
    font-size: 18px;
    width: 36px; height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    flex-shrink: 0;
    -webkit-appearance: none;
  }
  .btn-remove:active { background: rgba(255,107,107,0.15); color: #ff6b6b; }

  .add-bay-row {
    display: flex;
    gap: 8px;
  }
  .add-bay-row input { flex: 1; }
  .add-bay-row input:first-child { max-width: 90px; }

  /* LOADING */
  .loading-state {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 14px 0;
    color: var(--rei-muted);
    font-size: 14px;
  }
  .spinner {
    width: 18px; height: 18px;
    border: 2px solid var(--rei-border);
    border-top-color: var(--rei-green);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    flex-shrink: 0;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* MODAL */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.88);
    z-index: 200;
    display: flex;
    align-items: flex-end; /* sheet from bottom on mobile */
    justify-content: center;
    padding: 20px;
    padding-bottom: calc(20px + var(--safe-bottom));
  }

  @media (min-width: 500px) {
    .modal-overlay { align-items: center; }
  }

  .modal {
    background: #2a2a2a;
    border: 1px solid var(--rei-border);
    border-radius: 20px;
    padding: 28px 24px;
    max-width: 420px;
    width: 100%;
  }
  .modal h2 {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 900;
    font-size: 26px;
    margin-bottom: 6px;
  }
  .modal p { font-size: 14px; color: var(--rei-muted); line-height: 1.6; margin-bottom: 12px; }
  .modal .btn { width: 100%; margin-top: 14px; }

  /* NOTIFICATION ‚Äî bottom-safe on iOS */
  .notif {
    position: fixed;
    bottom: calc(24px + var(--safe-bottom));
    left: 50%;
    transform: translateX(-50%);
    background: var(--rei-green);
    color: white;
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 700;
    font-size: 15px;
    padding: 11px 22px;
    border-radius: 40px;
    z-index: 300;
    opacity: 0;
    transition: opacity 0.25s;
    pointer-events: none;
    white-space: nowrap;
    box-shadow: 0 4px 16px rgba(0,0,0,0.4);
  }
  .notif.show { opacity: 1; }

  .empty-bay { color: var(--rei-muted); font-size: 14px; padding: 8px 0; }

  /* Divider */
  .divider {
    border: none;
    border-top: 1px solid var(--rei-border);
    margin: 4px 0;
  }
</style>
</head>
<body>

<!-- API Key Modal -->
<div class="modal-overlay" id="api-modal">
  <div class="modal">
    <h2>üîë Setup</h2>
    <p>Enter your Anthropic API key to enable AI-powered shoe analysis. Stored only for this session.</p>
    <input type="text" id="api-key-input" placeholder="sk-ant-..."
      autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
      style="font-family: monospace;" />
    <button class="btn btn-primary" onclick="saveApiKey()">Save & Start</button>
    <p style="margin-top: 10px; font-size: 12px; text-align:center;">
      Get a key at <a href="https://console.anthropic.com" target="_blank" style="color: var(--rei-green);">console.anthropic.com</a>
    </p>
  </div>
</div>

<div class="notif" id="notif"></div>

<!-- Hidden iOS native camera input -->
<input type="file" id="ios-camera-input" accept="image/*" capture="environment" />

<header>
  <div class="rei-logo">REI</div>
  <h1>Footwear Assistant</h1>
</header>

<main>

  <!-- SCAN SECTION -->
  <div class="scan-section">

    <!-- Camera card -->
    <div class="scan-card">
      <div class="card-label">üì∑ Scan Barcode</div>

      <!-- Live camera view (works on Android + some iOS) -->
      <div id="quagga-container">
        <div class="scan-corner tl"></div>
        <div class="scan-corner tr"></div>
        <div class="scan-corner bl"></div>
        <div class="scan-corner br"></div>
        <div class="scan-anim-line" id="scan-anim"></div>
      </div>

      <div id="scan-status">Camera off</div>

      <div class="btn-row">
        <button class="btn btn-primary" id="cam-btn" onclick="toggleCamera()">Start Camera</button>
        <button class="btn btn-secondary" onclick="resetAll()" style="flex:0; padding: 12px 16px;">‚Ü∫</button>
      </div>

      <!-- iOS fallback: use native camera to capture barcode image -->
      <button class="btn btn-secondary" id="ios-fallback-btn" onclick="triggerIOSCamera()" style="display:none;">
        üì∏ Use iPhone Camera
      </button>
    </div>

    <!-- Manual entry card -->
    <div class="scan-card">
      <div class="card-label">‚å®Ô∏è Manual Entry</div>

      <div>
        <label style="font-size:12px; color: var(--rei-muted); display:block; margin-bottom:6px;">Barcode / UPC</label>
        <input type="text" id="manual-barcode" placeholder="e.g. 888392524751"
          inputmode="numeric" autocomplete="off" autocorrect="off" autocapitalize="off" />
      </div>

      <div style="text-align:center; color: var(--rei-muted); font-size:12px;">‚Äî or ‚Äî</div>

      <div>
        <label style="font-size:12px; color: var(--rei-muted); display:block; margin-bottom:6px;">Product Name</label>
        <input type="text" id="manual-name" placeholder="e.g. Hoka Speedgoat 5 Men's"
          autocomplete="off" autocorrect="off" autocapitalize="words" />
      </div>

      <button class="btn btn-accent" onclick="analyzeShoeManual()">Analyze Shoe ‚Üí</button>

      <hr class="divider" />

      <div class="card-label" style="margin-bottom:8px;">üîë API Key</div>
      <div style="display:flex; gap:8px;">
        <input type="text" id="key-inline" placeholder="sk-ant-..."
          style="font-size:14px; font-family:monospace; flex:1;"
          autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
        <button class="btn btn-secondary btn-sm" onclick="updateKey()" style="flex:0; white-space:nowrap;">Set</button>
      </div>
    </div>
  </div>

  <!-- RESULT SECTION -->
  <div id="result-section">

    <div class="product-header">
      <div class="badge-row">
        <div class="product-badge" id="product-brand">BRAND</div>
        <div class="product-badge" style="background: var(--rei-border); color: var(--rei-muted);" id="product-type">TYPE</div>
        <div class="product-badge" style="background: var(--rei-accent);" id="product-price">PRICE</div>
      </div>
      <div class="product-name" id="product-name">Loading...</div>
      <div class="product-meta">
        <span id="meta-gender"></span>
        <span id="meta-terrain"></span>
        <span id="meta-drop"></span>
      </div>
    </div>

    <div class="cards-grid">
      <div class="info-card">
        <h3>‚úì Pros</h3>
        <ul class="pros-list" id="pros-list">
          <li class="loading-state"><div class="spinner"></div> Analyzing...</li>
        </ul>
      </div>
      <div class="info-card">
        <h3>‚Äî Cons</h3>
        <ul class="cons-list" id="cons-list">
          <li class="loading-state"><div class="spinner"></div> Analyzing...</li>
        </ul>
      </div>
      <div class="info-card">
        <h3>üë§ Who It's For</h3>
        <div class="target-text" id="target-text">
          <div class="loading-state"><div class="spinner"></div> Analyzing...</div>
        </div>
      </div>
      <div class="info-card">
        <h3>üìã Key Specs</h3>
        <div class="specs-grid" id="specs-grid">
          <div class="loading-state"><div class="spinner"></div> Loading...</div>
        </div>
      </div>
    </div>

    <div class="bay-card">
      <div class="bay-header">
        <h3>üì¶ Warehouse Bays</h3>
        <div class="bay-btn-row">
          <button class="btn btn-secondary btn-sm" onclick="clearRetrieved()">Clear Done</button>
          <button class="btn btn-secondary btn-sm" onclick="clearAllBays()">Clear All</button>
        </div>
      </div>
      <div class="bay-list" id="bay-list">
        <div class="empty-bay">Add bays below.</div>
      </div>
      <div class="add-bay-row">
        <input type="text" id="bay-num-input" placeholder="Bay #" inputmode="text" autocomplete="off" autocorrect="off" autocapitalize="characters" />
        <input type="text" id="bay-size-input" placeholder="Size / Note" autocomplete="off" autocorrect="off" />
        <button class="btn btn-primary btn-sm" onclick="addBayManual()" style="flex:0; white-space:nowrap;">+ Add</button>
      </div>
    </div>

  </div><!-- end result-section -->
</main>

<script>
// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let apiKey = '';
let scanningActive = false;
let currentProduct = null;
let bays = [];

// ‚îÄ‚îÄ iOS DETECTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

// Show iOS fallback button if on iOS Safari (Quagga is unreliable there)
if (isIOS && isSafari) {
  document.getElementById('ios-fallback-btn').style.display = 'flex';
}

// ‚îÄ‚îÄ API KEY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveApiKey() {
  const val = document.getElementById('api-key-input').value.trim();
  if (!val.startsWith('sk-')) { alert('Enter a valid Anthropic API key (starts with sk-)'); return; }
  apiKey = val;
  // Persist across page refreshes
  try { localStorage.setItem('rei_api_key', val); } catch(e) {}
  document.getElementById('api-modal').style.display = 'none';
  showNotif('API key saved ‚úì');
}

function updateKey() {
  const val = document.getElementById('key-inline').value.trim();
  if (!val.startsWith('sk-')) { showNotif('Invalid key format'); return; }
  apiKey = val;
  try { localStorage.setItem('rei_api_key', val); } catch(e) {}
  document.getElementById('api-modal').style.display = 'none';
  showNotif('API key updated ‚úì');
}

// Auto-load saved key on startup
(function() {
  try {
    const saved = localStorage.getItem('rei_api_key');
    if (saved && saved.startsWith('sk-')) {
      apiKey = saved;
      document.getElementById('api-modal').style.display = 'none';
      document.getElementById('key-inline').value = saved;
    }
  } catch(e) {}
})();

// ‚îÄ‚îÄ NOTIFICATIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showNotif(msg, duration = 2500) {
  const el = document.getElementById('notif');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), duration);
}

// ‚îÄ‚îÄ CAMERA (Quagga ‚Äî works on Android & Chrome iOS) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleCamera() { scanningActive ? stopCamera() : startCamera(); }

function startCamera() {
  document.getElementById('scan-status').textContent = 'Starting camera...';
  document.getElementById('cam-btn').textContent = 'Stop Camera';

  Quagga.init({
    inputStream: {
      name: 'Live',
      type: 'LiveStream',
      target: document.getElementById('quagga-container'),
      constraints: {
        facingMode: 'environment',
        width: { ideal: 1280 },
        height: { ideal: 960 }
      }
    },
    decoder: {
      readers: ['ean_reader','ean_8_reader','upc_reader','upc_e_reader','code_128_reader','code_39_reader']
    },
    locate: true
  }, err => {
    if (err) {
      console.warn('Quagga init error:', err);
      document.getElementById('scan-status').textContent = 'Camera unavailable ‚Äî use iPhone Camera button below or manual entry';
      document.getElementById('cam-btn').textContent = 'Start Camera';
      document.getElementById('ios-fallback-btn').style.display = 'flex';
      return;
    }
    Quagga.start();
    scanningActive = true;
    document.getElementById('scan-anim').style.display = 'block';
    document.getElementById('scan-status').textContent = 'Point camera at barcode...';
  });

  let lastCode = null;
  Quagga.onDetected(result => {
    const code = result.codeResult.code;
    if (code && code !== lastCode) {
      lastCode = code;
      // Haptic feedback on iOS
      if (navigator.vibrate) navigator.vibrate(50);
      stopCamera();
      document.getElementById('manual-barcode').value = code;
      showNotif('Scanned: ' + code);
      analyzeShoe(code, null);
    }
  });
}

function stopCamera() {
  if (scanningActive) { Quagga.stop(); scanningActive = false; }
  document.getElementById('cam-btn').textContent = 'Start Camera';
  document.getElementById('scan-anim').style.display = 'none';
  document.getElementById('scan-status').textContent = 'Camera off';
}

// ‚îÄ‚îÄ iOS NATIVE CAMERA FALLBACK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Uses <input type="file" capture> which triggers native iOS camera.
// The image is then processed by Quagga's static image decoder.
function triggerIOSCamera() {
  document.getElementById('ios-camera-input').click();
}

document.getElementById('ios-camera-input').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;

  document.getElementById('scan-status').textContent = 'Processing image...';

  const url = URL.createObjectURL(file);

  Quagga.decodeSingle({
    decoder: {
      readers: ['ean_reader','ean_8_reader','upc_reader','upc_e_reader','code_128_reader','code_39_reader']
    },
    locate: true,
    src: url
  }, result => {
    URL.revokeObjectURL(url);
    // Reset file input so same image can be re-selected
    e.target.value = '';

    if (result && result.codeResult) {
      const code = result.codeResult.code;
      document.getElementById('manual-barcode').value = code;
      showNotif('Scanned: ' + code);
      analyzeShoe(code, null);
    } else {
      document.getElementById('scan-status').textContent = 'No barcode found ‚Äî try again or enter manually';
      showNotif('No barcode detected ‚Äî try again', 3000);
    }
  });
});

// ‚îÄ‚îÄ ANALYZE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function analyzeShoeManual() {
  const barcode = document.getElementById('manual-barcode').value.trim();
  const name = document.getElementById('manual-name').value.trim();
  if (!barcode && !name) { showNotif('Enter a barcode or product name'); return; }
  // Dismiss keyboard on mobile
  document.activeElement?.blur();
  analyzeShoe(barcode || null, name || null);
}

async function analyzeShoe(barcode, productName) {
  if (!apiKey) { document.getElementById('api-modal').style.display = 'flex'; return; }
  document.getElementById('result-section').classList.add('visible');
  setLoadingState();
  // Scroll to results
  setTimeout(() => document.getElementById('result-section').scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
  const result = await runAIAnalysis(barcode, productName);
  if (result) renderProduct(result);
  else showNotif('Analysis failed ‚Äî check your API key', 4000);
}

async function runAIAnalysis(barcode, productName) {
  const prompt = `You are an expert footwear specialist at REI. Given this shoe ${barcode ? `barcode/UPC: ${barcode}` : ''}${productName ? ` product name: "${productName}"` : ''}, provide detailed information.

Respond ONLY with valid JSON (no markdown fences):
{
  "brand": "Brand Name",
  "name": "Full Product Name",
  "type": "Trail Running / Road Running / Hiking / Approach / etc",
  "gender": "Men's / Women's / Unisex",
  "terrain": "Trail / Road / Multi-Terrain / etc",
  "price": "$XXX",
  "drop": "Xmm drop",
  "pros": ["Pro 1", "Pro 2", "Pro 3", "Pro 4"],
  "cons": ["Con 1", "Con 2", "Con 3"],
  "who_for": "2-3 sentence description of the ideal customer: fitness level, use case, foot type, experience level, etc.",
  "specs": {
    "Weight": "X oz (men's 9)",
    "Stack Height": "XXmm heel / XXmm toe",
    "Drop": "Xmm",
    "Upper": "Material description",
    "Midsole": "Foam type",
    "Outsole": "Rubber/lug description",
    "Waterproof": "Yes / No",
    "Last": "Standard / Wide / Narrow"
  }
}`;

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        messages: [{ role: 'user', content: prompt }]
      }),
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error.message);
    return JSON.parse(data.content[0].text.replace(/```json|```/g, '').trim());
  } catch (err) {
    console.error('AI error:', err);
    return null;
  }
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setLoadingState() {
  const load = '<li class="loading-state"><div class="spinner"></div> Analyzing...</li>';
  document.getElementById('pros-list').innerHTML = load;
  document.getElementById('cons-list').innerHTML = load;
  document.getElementById('target-text').innerHTML = '<div class="loading-state"><div class="spinner"></div> Analyzing...</div>';
  document.getElementById('specs-grid').innerHTML = '<div class="loading-state"><div class="spinner"></div> Loading...</div>';
  document.getElementById('product-name').textContent = 'Analyzing...';
  bays = [];
  renderBayList();
}

function renderProduct(p) {
  currentProduct = p;
  document.getElementById('product-name').textContent = p.name;
  document.getElementById('product-brand').textContent = p.brand;
  document.getElementById('product-type').textContent = p.type;
  document.getElementById('product-price').textContent = p.price;
  document.getElementById('meta-gender').textContent = p.gender || '';
  document.getElementById('meta-terrain').textContent = p.terrain ? '¬∑ ' + p.terrain : '';
  document.getElementById('meta-drop').textContent = p.drop ? '¬∑ ' + p.drop : '';
  document.getElementById('pros-list').innerHTML = (p.pros || []).map(x => `<li>${x}</li>`).join('');
  document.getElementById('cons-list').innerHTML = (p.cons || []).map(x => `<li>${x}</li>`).join('');
  document.getElementById('target-text').textContent = p.who_for || '';
  document.getElementById('specs-grid').innerHTML = Object.entries(p.specs || {}).map(([k,v]) =>
    `<div class="spec-item"><div class="spec-label">${k}</div><div class="spec-value">${v}</div></div>`
  ).join('');
}

// ‚îÄ‚îÄ BAY LIST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderBayList() {
  const list = document.getElementById('bay-list');
  if (!bays.length) {
    list.innerHTML = '<div class="empty-bay">Add bays below.</div>';
    return;
  }
  list.innerHTML = bays.map((b, i) => `
    <div class="bay-item ${b.done ? 'retrieved' : ''}">
      <div class="bay-number">
        <input type="text" value="${b.bay}" placeholder="Bay"
          autocomplete="off" autocorrect="off" autocapitalize="characters"
          oninput="bays[${i}].bay = this.value" />
      </div>
      <div class="bay-details">
        <div class="bay-size">${b.note}</div>
        <div class="bay-sub">${currentProduct ? currentProduct.name : ''}</div>
      </div>
      <button class="bay-check" onclick="toggleBay(${i})">${b.done ? '‚úì' : ''}</button>
      <button class="btn-remove" onclick="removeBay(${i})">‚úï</button>
    </div>`).join('');
}

function toggleBay(i) { bays[i].done = !bays[i].done; renderBayList(); }
function removeBay(i) { bays.splice(i, 1); renderBayList(); }

function addBayManual() {
  const bayNum = document.getElementById('bay-num-input').value.trim();
  const bayNote = document.getElementById('bay-size-input').value.trim();
  if (!bayNote) { showNotif('Enter a size or note'); return; }
  bays.push({ bay: bayNum, note: bayNote, done: false });
  document.getElementById('bay-num-input').value = '';
  document.getElementById('bay-size-input').value = '';
  document.activeElement?.blur();
  renderBayList();
}

function clearRetrieved() { bays = bays.filter(b => !b.done); renderBayList(); showNotif('Cleared retrieved items'); }
function clearAllBays() { bays = []; renderBayList(); }

function resetAll() {
  stopCamera();
  currentProduct = null;
  bays = [];
  document.getElementById('manual-barcode').value = '';
  document.getElementById('manual-name').value = '';
  document.getElementById('result-section').classList.remove('visible');
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Prevent double-tap zoom on buttons (iOS)
document.querySelectorAll('.btn, .bay-check, .btn-remove').forEach(el => {
  el.addEventListener('touchend', e => e.preventDefault(), { passive: false });
});
</script>
</body>
</html>
